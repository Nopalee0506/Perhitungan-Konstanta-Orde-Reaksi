import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

st.set_page_config(page_title="Penentuan Orde Reaksi", layout="centered")

# ===== SIDEBAR =====
with st.sidebar:
    st.header("âš™ï¸ Pengaturan Analisis")

    orde_dipilih = st.multiselect(
        "Pilih orde reaksi",
        ["Orde 0", "Orde 1", "Orde 2"],
        default=["Orde 1", "Orde 2"]
    )

    tampil_grafik = st.checkbox("Tampilkan grafik", True)
    judul_grafik = st.text_input("Judul grafik", "Plot Kinetika Reaksi")
    ukuran_font = st.slider("Ukuran font", 8, 20, 12)

# ===== MAIN PAGE =====
st.title("Penentuan Orde Reaksi")
st.write("Aplikasi ini menentukan orde reaksi berdasarkan data waktu dan absorbansi.")

uploaded_file = st.file_uploader("Upload file CSV (waktu, absorbansi)", type=["csv"])

if uploaded_file is not None:
    df = pd.read_csv(uploaded_file)

    st.subheader("Data Input")
    st.dataframe(df)

    t = df.iloc[:,0].values
    A = df.iloc[:,1].values

    if (A <= 0).any():
        st.error("âŒ Nilai absorbansi harus > 0")
        st.stop()

    def regresi(x,y):
        n=len(x)
        sx, sy = np.sum(x), np.sum(y)
        sxy = np.sum(x*y)
        sx2 = np.sum(x*x)
        m=(n*sxy-sx*sy)/(n*sx2-sx*sx)

        y_pred = m*x + (sy-m*sx)/n
        r2 = 1 - np.sum((y-y_pred)**2)/np.sum((y-np.mean(y))**2)
        return m, r2

    if st.button("ğŸ“Š Analisis Orde"):
        hasil=[]

        if "Orde 0" in orde_dipilih:
            k0,r20 = regresi(t,A)
            hasil.append(("Orde 0",k0,r20))

        if "Orde 1" in orde_dipilih:
            k1,r21 = regresi(t,np.log(A[0]/A))
            hasil.append(("Orde 1",k1,r21))

        if "Orde 2" in orde_dipilih:
            k2,r22 = regresi(t,(1/A - 1/A[0]))
            hasil.append(("Orde 2",k2,r22))

        df_hasil = pd.DataFrame(hasil, columns=["Orde","k","RÂ²"])
        st.subheader("Hasil Regresi")
        st.dataframe(df_hasil)

        terbaik = df_hasil.sort_values("RÂ²",ascending=False).iloc[0]
        st.success(f"ğŸ“Œ Orde reaksi terbaik: {terbaik['Orde']} (RÂ²={terbaik['RÂ²']:.4f})")

        if tampil_grafik:
            fig,ax = plt.subplots()
            for o,_,_ in hasil:
                if o=="Orde 0": ax.plot(t,A,'o-',label=o)
                if o=="Orde 1": ax.plot(t,np.log(A[0]/A),'o-',label=o)
                if o=="Orde 2": ax.plot(t,(1/A - 1/A[0]),'o-',label=o)

            ax.set_title(judul_grafik,fontsize=ukuran_font)
            ax.set_xlabel("Waktu")
            ax.set_ylabel("Fungsi Kinetika")
            ax.legend()
            st.pyplot(fig)
